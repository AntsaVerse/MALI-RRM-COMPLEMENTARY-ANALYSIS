---
title: "IMPACT MALI I Analyse RRM"
date: "01/28/2026"
author: "Antsa RAJAONAH"
format:
    html:
        theme: cosmo
        self-contained: true
        code-fold: true
        toc: true
        toc-location: left
        toc-depth: 3
        smooth-scroll: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
invisible(Sys.setlocale("LC_TIME", "C"))
```

```{r importation, echo=FALSE, message=FALSE, warning=FALSE }
rm(list=ls())

library(tidyverse)
library(lubridate)
library(stringr)
library(openxlsx)
library(readxl)
library(knitr)
library(kableExtra)

#devtools:: install_github("AntsaVerse/rrminfo")
library(rrminfo)


df_alerte <- read.xlsx("data/data_for_dashboard/MLI_DB_PowerBI.xlsx",sheet="Alertes",detectDates = T)

df_alerte<-df_alerte%>%rename(uuid=ID.Alerte,
                              date_incident=`Date.de.l'incident./.mouvement`,
                              date_validation=`Date.de.la.validation.d'alerte`,
                              menages_estimes=`Nombre.de.ménages.estimés`,
                              personnes_estimees=`Nombre.de.personnes.estimées`,
                              statut_alerte=`Statut.d'alerte`,
                              type_crise=`Type.de.crise`,
                              region_arrivee=`Arrivée:.Nom.de.la.région`)

df_evaluation <- read.xlsx("data/data_for_dashboard/MLI_DB_PowerBI.xlsx",sheet="Evaluations",detectDates = T,
cols=c(1,26:34)) |> rename(uuid=ID.Alerte)

df_rrm <- read.xlsx("data/data_for_dashboard/MLI_DB_PowerBI.xlsx",sheet="Reponses",detectDates = T)

df_rrm <-df_rrm%>%rename(uuid=ID.Alerte, modalites_reponse=Modalité.de.réponse,
                         date_debut_reponse=Date.de.debut.de.la.réponse,
                         date_fin_reponse=Date.de.la.fin.de.la.réponse,
                         menages_assistes=Nombre.de.ménages.assistés,
                         personnes_assistees=Nombre.de.personnes.assistés,
                         reponse_vivres=Réponse.en.vivres,
                         reponse_EHA=Réponse.en.EHA,
                         reponse_BNA=Réponse.en.BNA,
                         reponse_abris=Réponse.en.Abris,
                         reponse_sante=Réponse.en.Santé,
                         reponseprotection=Réponse.en.Protection,
                         reponse_MHM=Réponse.en.MHM,
                         reponse_nutrition=Réponse.en.nutrition,
                         reponse_education=Réponse.en.Education,
                         bailleur_reponse=Bailleur,
                         region_reponse=`Réponse:.Nom.de.la.région`,
                         cercle_reponse=`Réponse:.Nom.du.cercle`)



```

```{r fonction_date, echo=FALSE, message=FALSE, warning=FALSE }
get_bimestre <- function(date) {
  ceiling(lubridate::month(date)/2)
}

get_trimestre <- function(date) {
  ceiling(lubridate::month(date) / 3)
}
```

```{r, echo=FALSE, warning=FALSE }
alerte_vivres <- df_evaluation |> filter(Besoins.en.Vivres == 1) |> pull(uuid)
alerte_nutrition <- df_evaluation |> filter(Besoins.en.Nutrition == 1) |> pull(uuid)
alerte_eha <- df_evaluation |> filter(Besoins.en.EHA == 1) |> pull(uuid)
alerte_abris <- df_evaluation |> filter(Besoins.en.Abris == 1) |> pull(uuid)
alerte_bna <- df_evaluation |> filter(Besoins.en.BNA == 1) |> pull(uuid)
alerte_education <- df_evaluation |> filter(Besoins.en.Education == 1) |> pull(uuid)
alerte_sante <- df_evaluation |> filter(Besoins.en.Santé == 1) |> pull(uuid)
alerte_protection <- df_evaluation |> filter(Besoins.en.Protection == 1) |> pull(uuid)
alerte_mhm <- df_evaluation |> filter(Besoins.en.MHM == 1) |> pull(uuid)

df_alerte_vivres <- df_alerte |> filter(uuid %in% alerte_vivres)
df_alerte_nutrition <- df_alerte |> filter(uuid %in% alerte_nutrition)
df_alerte_eha <- df_alerte |> filter(uuid %in% alerte_eha)
df_alerte_abris <- df_alerte |> filter(uuid %in% alerte_abris)
df_alerte_bna <- df_alerte |> filter(uuid %in% alerte_bna)
df_alerte_education <- df_alerte |> filter(uuid %in% alerte_education)
df_alerte_sante <- df_alerte |> filter(uuid %in% alerte_sante)
df_alerte_protection <- df_alerte |> filter(uuid %in% alerte_protection)
df_alerte_mhm <- df_alerte |> filter(uuid %in% alerte_mhm)

df_rrm_vivres <- df_rrm |> filter(reponse_vivres==1)
df_rrm_nutrition <- df_rrm |> filter(reponse_nutrition==1)
df_rrm_eha <- df_rrm |> filter(reponse_EHA==1)
df_rrm_abris <- df_rrm |> filter(reponse_abris==1)
df_rrm_bna <- df_rrm |> filter(reponse_BNA==1)
df_rrm_education <- df_rrm |> filter(reponse_education==1)
df_rrm_sante <- df_rrm |> filter(reponse_sante==1)
df_rrm_protection <- df_rrm |> filter(reponseprotection==1)
df_rrm_mhm <- df_rrm |> filter(reponse_MHM==1)

rrm_vivres_uuid <- df_rrm |> filter(reponse_vivres==1) |> mutate(dupl=duplicated(uuid)) |> filter(dupl==F) |> pull(uuid)
rrm_nutrition_uuid <- df_rrm |> filter(reponse_nutrition==1) |> mutate(dupl=duplicated(uuid)) |> filter(dupl==F) |> pull(uuid)
rrm_eha_uuid <- df_rrm |> filter(reponse_EHA==1) |> mutate(dupl=duplicated(uuid)) |> filter(dupl==F) |> pull(uuid)
rrm_abris_uuid <- df_rrm |> filter(reponse_abris==1) |> mutate(dupl=duplicated(uuid)) |> filter(dupl==F) |> pull(uuid)
rrm_bna_uuid <- df_rrm |> filter(reponse_BNA==1) |> mutate(dupl=duplicated(uuid)) |> filter(dupl==F) |> pull(uuid)
rrm_education_uuid <- df_rrm |> filter(reponse_education==1) |> mutate(dupl=duplicated(uuid)) |> filter(dupl==F) |> pull(uuid)
rrm_sante_uuid <- df_rrm |> filter(reponse_sante==1) |> mutate(dupl=duplicated(uuid)) |> filter(dupl==F) |> pull(uuid)
rrm_protection_uuid <- df_rrm |> filter(reponseprotection==1) |> mutate(dupl=duplicated(uuid)) |> filter(dupl==F) |> pull(uuid)
rrm_mhm_uuid <- df_rrm |> filter(reponse_MHM==1) |> mutate(dupl=duplicated(uuid)) |> filter(dupl==F) |> pull(uuid)

```

Cette analyse porte sur les données de la coordination RRM au Mali mises à jour le
<span style="color:red;">`r format(as.Date("2026-01-28"), "%b %d, %Y")`</span>.  
Elle est complémentaire au tableau de bord Power BI disponible à l’adresse suivante :  
<a href="https://dashboards.impact-initiatives.org/mli/rrm/" target="_blank">
Dashboard RRM Mali Coordination
</a>

### Période d'analyse

```{r parameter, echo=FALSE, message=FALSE, warning=FALSE }
date_periode_act <- as.Date("2026-02-23")

date_periode_prec_month <- date_periode_act %m-% months(1)
date_periode_prec_bim <- date_periode_act %m-% months(2)
date_periode_prec_trim <- date_periode_act %m-% months(3)
date_periode_prec_year <- date_periode_act %m-% years(1)

year_ref <- year(date_periode_act)
quarter_ref <- quarter(date_periode_act)
bim_ref <- get_bimestre(date_periode_act)
month_ref <- month(date_periode_act)
month_ref_lab <- format(date_periode_act, "%B")

```

La période d'analyse mensuelle va de 
<span style="color:red;">`r date_periode_prec_month`</span> à
<span style="color:red;">`r date_periode_act`</span> . La période d'analyse bimensuelle va de 
<span style="color:red;">`r date_periode_prec_bim`</span> à
<span style="color:red;">`r date_periode_act`</span> .La période d'analyse trimensuelle va de 
<span style="color:red;">`r date_periode_prec_trim`</span> à
<span style="color:red;">`r date_periode_act`</span> . La période d'analyse annuelle va de 
<span style="color:red;">`r date_periode_prec_year`</span> à
<span style="color:red;">`r date_periode_act`</span> .

L'analyse des réponses à la section 15, considère le mois de <span style="color:red;">`r month_ref_lab`</span> du <span style="color:red;">Bimestre `r bim_ref`</span> du <span style="color:red;">Trimestre `r quarter_ref`</span> de l'année <span style="color:red;">`r year_ref`</span> comme référence pour les réponses en cours.

### Alertes validées par mois

::: {.panel-tabset}

## Tous secteurs

```{r validated_alert, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_month<-df_alerte%>%
  mutate(mois_alerte=factor(format(date_incident, "%B"), 
                            levels = month.name, ordered = TRUE),
         mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num, mois_alerte)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |>
  arrange(annee_alerte, mois_num) |> 
  ungroup() |> 
  select(-mois_num)

```

```{r plot_validated_alert}
summary_alert_by_month %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par mois",
               col.names = colnames(summary_alert_by_month)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

## Vivres

```{r validated_alert_vivres, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_month<-df_alerte_vivres%>%
  mutate(mois_alerte=factor(format(date_incident, "%B"), 
                            levels = month.name, ordered = TRUE),
         mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num, mois_alerte)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)|>
  arrange(annee_alerte, mois_num) |> 
  ungroup() |> 
  select(-mois_num)

```

```{r plot_validated_alert_vivres}
summary_alert_by_month %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par mois (Vivres)",
               col.names = colnames(summary_alert_by_month)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

## Nutrition

```{r validated_alert_nutrtion, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_month<-df_alerte_nutrition%>%
  mutate(mois_alerte=factor(format(date_incident, "%B"), 
                            levels = month.name, ordered = TRUE),
         mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num, mois_alerte)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)|>
  arrange(annee_alerte, mois_num) |> 
  ungroup() |> 
  select(-mois_num)

```

```{r plot_validated_alert_nutrition}
summary_alert_by_month %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par mois (Nutrition)",
               col.names = colnames(summary_alert_by_month)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

## EHA

```{r validated_alert_EHA, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_month<-df_alerte_eha%>%
  mutate(mois_alerte=factor(format(date_incident, "%B"), 
                            levels = month.name, ordered = TRUE),
         mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num, mois_alerte)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)|>
  arrange(annee_alerte, mois_num) |> 
  ungroup() |> 
  select(-mois_num)

```

```{r plot_validated_alert_eha}
summary_alert_by_month %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par mois (EHA)",
               col.names = colnames(summary_alert_by_month)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

## Abris

```{r validated_alert_abris, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_month<-df_alerte_abris%>%
  mutate(mois_alerte=factor(format(date_incident, "%B"), 
                            levels = month.name, ordered = TRUE),
         mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num, mois_alerte)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)|>
  arrange(annee_alerte, mois_num) |> 
  ungroup() |> 
  select(-mois_num)

```

```{r plot_validated_alert_abris}
summary_alert_by_month %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par mois (Abris)",
               col.names = colnames(summary_alert_by_month)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

## BNA

```{r validated_alert_bna, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_month<-df_alerte_bna%>%
  mutate(mois_alerte=factor(format(date_incident, "%B"), 
                            levels = month.name, ordered = TRUE),
         mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num, mois_alerte)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)|>
  arrange(annee_alerte, mois_num) |> 
  ungroup() |> 
  select(-mois_num)

```

```{r plot_validated_alert_bna}
summary_alert_by_month %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par mois (Abris)",
               col.names = colnames(summary_alert_by_month)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

## Education

```{r validated_alert_educ, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_month<-df_alerte_education%>%
  mutate(mois_alerte=factor(format(date_incident, "%B"), 
                            levels = month.name, ordered = TRUE),
         mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num, mois_alerte)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |>
  arrange(annee_alerte, mois_num) |> 
  ungroup() |> 
  select(-mois_num)

```

```{r plot_validated_alert_educ}
summary_alert_by_month %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par mois (Education)",
               col.names = colnames(summary_alert_by_month)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

## Santé

```{r validated_alert_sant, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_month<-df_alerte_sante%>%
  mutate(mois_alerte=factor(format(date_incident, "%B"), 
                            levels = month.name, ordered = TRUE),
         mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num, mois_alerte)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)|>
  arrange(annee_alerte, mois_num) |> 
  ungroup() |> 
  select(-mois_num)

```

```{r plot_validated_alert_sant}
summary_alert_by_month %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par mois (Santé)",
               col.names = colnames(summary_alert_by_month)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

## Protection

```{r validated_alert_prot, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_month<-df_alerte_protection%>%
  mutate(mois_alerte=factor(format(date_incident, "%B"), 
                            levels = month.name, ordered = TRUE),
         mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num, mois_alerte)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)|>
  arrange(annee_alerte, mois_num) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r plot_validated_alert_prot}
summary_alert_by_month %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par mois (Protection)",
               col.names = colnames(summary_alert_by_month)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

## MHM

```{r validated_alert_mhm, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_month<-df_alerte_mhm%>%
  mutate(mois_alerte=factor(format(date_incident, "%B"), 
                            levels = month.name, ordered = TRUE),
         mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num, mois_alerte)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)|>
  arrange(annee_alerte, mois_num) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r plot_validated_alert_mhm}
summary_alert_by_month %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par mois (MHM)",
               col.names = colnames(summary_alert_by_month)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

:::

### Analyse temporelle

::: {.panel-tabset tabset-toc="true"}

## Analyse mensuelle
::: {.panel-tabset}

### Tous secteurs 

#### Alertes validées par type

```{r alert_type_mois, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_mois<-df_alerte%>%
  mutate(mois = format(date_incident, "%B"), 
         mois_num = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,type_crise)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r plot_alert_type_mois}
summary_alert_by_type_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region

```{r alert_region_mois, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_mois<-df_alerte%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,region_arrivee)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)|> 
  ungroup() |> 
  select(-mois_num)
```

```{r plot_alert_region_mois}
summary_alert_by_region_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite

```{r alert_modality_mois, echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_mois <-df_rrm%>%
  filter(date_fin_reponse>=date_periode_prec_month&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_mois <-df_rrm_for_analysis_mois%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r plot_alert_modality_mois}
summary_reponse_by_modalite_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM

```{r data_reshape_mois, echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm) > 0) {

df_rrm$me=NA

rrm_reshaped_mois <- process_response_data(
  df_rrm,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm<-df_rrm%>%select(-me)

rrm_reshaped_mois<-rrm_reshaped_mois%>%select(-me)
} else {
rrm_reshaped_mois <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r data_reshape_2_mois, echo=FALSE, message=FALSE, warning=FALSE }

 df_mois <- df_alerte %>% left_join(rrm_reshaped_mois, by=join_by(uuid == uuid))

```

```{r alert_rrm_mois, echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_mois <- df_mois %>%
  mutate(mois_incident = format(date_incident, "%B"),
        mois_num= month(date_incident),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, mois_num, mois_incident) %>%
  arrange(annee_incident, mois_num) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) |> 
  select(-mois_num)
```

```{r rrm_in_process_mois, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_mois_encours_mois<-df_mois%>%
  mutate(mois_incident = format(date_incident, "%B"),
        mois_num= month(date_incident),
         annee_incident = year(date_incident),
         rrm_mois_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        month(date_fin_reponse)==month_ref,1,0))%>%
  group_by(annee_incident, mois_num, mois_incident) %>%
  arrange(annee_incident, mois_num) %>%
  summarise(
    reponse_mensuelle_encours=sum(rrm_mois_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022) |> 
  ungroup() |> select(-mois_num)

summary_rrm_mois_encours_mois <-left_join(summary_rrm_mois_encours_mois,summary_alerte_rrm_mois%>%select(annee_incident,mois_incident,nb_alerte_sans_rrm),by=c("annee_incident","mois_incident"))

```

```{r plot_rrm_in_process_mois}

summary_rrm_mois_encours_mois %>%
  dplyr::select(annee_incident, mois_incident, reponse_mensuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Reponse du mois en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées

```{r cumulated_alert_mois}

summary_alerte_rrm_mois %>%
  dplyr::select(annee_incident, mois_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median

```{r median_time_mois,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_mois <- df_mois %>%
  mutate(mois = format(date_incident, "%B"), 
         mois_num     = month(date_incident),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, mois_num, mois) %>%
  arrange(annee, mois_num) %>%
  
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022) |> 
  ungroup() |> 
  select(-mois_num)
```


```{r plot_median_time_mois}
summary_response_time_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_mois<-df_rrm%>%
  mutate(mois = format(date_fin_reponse, "%B"),
        mois_num     = month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,mois_num,mois,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r donor_rrm_mois}
summary_rrm_by_bailleurs_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_mois<-df_rrm%>%
  mutate(mois = format(date_fin_reponse, "%B"),
        mois_num     = month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,mois_num,mois,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r plot_donor_rrm_mois}
summary_rrm_by_acteur_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Vivres

#### Alertes validées par type (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_mois<-df_alerte_vivres%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,type_crise)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_type_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_mois<-df_alerte_vivres%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,region_arrivee)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_region_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_mois <-df_rrm_vivres%>%
  filter(date_fin_reponse>=date_periode_prec_month&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_mois <-df_rrm_for_analysis_mois%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_vivres) > 0) {

df_rrm_vivres$me=NA

rrm_reshaped_mois <- process_response_data(
  df_rrm_vivres,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_vivres<-df_rrm_vivres%>%select(-me)

rrm_reshaped_mois<-rrm_reshaped_mois%>%select(-me)
} else {
  rrm_reshaped_mois <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_mois <- df_alerte_vivres %>% left_join(rrm_reshaped_mois, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_mois <- df_mois %>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_mois_encours_mois<-df_mois%>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident),
         rrm_mois_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        month(date_fin_reponse)==month_ref,1,0))%>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_mensuelle_encours=sum(rrm_mois_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_mois_encours_mois <-left_join(summary_rrm_mois_encours_mois,summary_alerte_rrm_mois%>%select(annee_incident,mois_incident,nb_alerte_sans_rrm),by=c("annee_incident","mois_incident"))

```

```{r }

summary_rrm_mois_encours_mois %>%
  dplyr::select(annee_incident, mois_incident, reponse_mensuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Reponse du mois en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Vivres)

```{r }

summary_alerte_rrm_mois %>%
  dplyr::select(annee_incident, mois_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Vivres)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_mois <- df_mois %>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, mois_num, mois) %>%
  arrange(annee, mois_num) %>%
  select(-mois_num) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Vivres)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_mois<-df_rrm%>%
    filter(uuid %in% rrm_vivres_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
          mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,mois_num,mois,bailleur_reponse)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_bailleurs_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Vivres)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_mois<-df_rrm%>%
    filter(uuid %in% rrm_vivres_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,Acteur)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_acteur_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Nutrition

#### Alertes validées par type (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_mois<-df_alerte_nutrition%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,type_crise)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_type_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_mois<-df_alerte_nutrition%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,region_arrivee)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_region_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_mois <-df_rrm_nutrition%>%
  filter(date_fin_reponse>=date_periode_prec_month&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_mois <-df_rrm_for_analysis_mois%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_nutrition) > 0) {
df_rrm_nutrition$me=NA

rrm_reshaped_mois <- process_response_data(
  df_rrm_nutrition,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_nutrition<-df_rrm_nutrition%>%select(-me)

rrm_reshaped_mois<-rrm_reshaped_mois%>%select(-me)
} else {
  rrm_reshaped_mois <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_mois <- df_alerte_nutrition %>% left_join(rrm_reshaped_mois, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_mois <- df_mois %>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_mois_encours_mois<-df_mois%>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident),
         rrm_mois_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        month(date_fin_reponse)==month_ref,1,0))%>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_mensuelle_encours=sum(rrm_mois_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_mois_encours_mois <-left_join(summary_rrm_mois_encours_mois,summary_alerte_rrm_mois%>%select(annee_incident,mois_incident,nb_alerte_sans_rrm),by=c("annee_incident","mois_incident"))

```

```{r }

summary_rrm_mois_encours_mois %>%
  dplyr::select(annee_incident, mois_incident, reponse_mensuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Reponse du mois en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Nutrition)

```{r }

summary_alerte_rrm_mois %>%
  dplyr::select(annee_incident, mois_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Nutrition)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_mois <- df_mois %>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, mois_num, mois) %>%
  arrange(annee, mois_num) %>%
  select(-mois_num) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Nutrition)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_mois<-df_rrm%>%
    filter(uuid %in% rrm_nutrition_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,bailleur_reponse)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_bailleurs_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Nutrition)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_mois<-df_rrm%>%
    filter(uuid %in% rrm_nutrition_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,Acteur)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_acteur_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### EHA

#### Alertes validées par type (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_mois<-df_alerte_eha%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,type_crise)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_type_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_mois<-df_alerte_eha%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,region_arrivee)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_region_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_mois <-df_rrm_eha%>%
  filter(date_fin_reponse>=date_periode_prec_month&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_mois <-df_rrm_for_analysis_mois%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_eha) > 0) {
df_rrm_eha$me=NA

rrm_reshaped_mois <- process_response_data(
  df_rrm_eha,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_eha<-df_rrm_eha%>%select(-me)

rrm_reshaped_mois<-rrm_reshaped_mois%>%select(-me)
} else {
  rrm_reshaped_mois <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_mois <- df_alerte_eha %>% left_join(rrm_reshaped_mois, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_mois <- df_mois %>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_mois_encours_mois<-df_mois%>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident),
         rrm_mois_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        month(date_fin_reponse)==month_ref,1,0))%>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_mensuelle_encours=sum(rrm_mois_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_mois_encours_mois <-left_join(summary_rrm_mois_encours_mois,summary_alerte_rrm_mois%>%select(annee_incident,mois_incident,nb_alerte_sans_rrm),by=c("annee_incident","mois_incident"))

```

```{r }

summary_rrm_mois_encours_mois %>%
  dplyr::select(annee_incident, mois_incident, reponse_mensuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Reponse du mois en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (EHA)

```{r }

summary_alerte_rrm_mois %>%
  dplyr::select(annee_incident, mois_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (EHA)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_mois <- df_mois %>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, mois_num, mois) %>%
  arrange(annee, mois_num) %>%
  select(-mois_num) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (EHA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_mois<-df_rrm%>%
    filter(uuid %in% rrm_eha_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,bailleur_reponse)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_bailleurs_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (EHA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_mois<-df_rrm%>%
    filter(uuid %in% rrm_eha_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,Acteur)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_acteur_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Abris

#### Alertes validées par type (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_mois<-df_alerte_abris%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,type_crise)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_type_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_mois<-df_alerte_abris%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,region_arrivee)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_region_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_mois <-df_rrm_abris%>%
  filter(date_fin_reponse>=date_periode_prec_month&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_mois <-df_rrm_for_analysis_mois%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_abris) > 0) {
df_rrm_abris$me=NA

rrm_reshaped_mois <- process_response_data(
  df_rrm_abris,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Abris",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_abris<-df_rrm_abris%>%select(-me)

rrm_reshaped_mois<-rrm_reshaped_mois%>%select(-me)
} else {
  rrm_reshaped_mois <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_Abris        = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_mois <- df_alerte_abris %>% left_join(rrm_reshaped_mois, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_mois <- df_mois %>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_mois_encours_mois<-df_mois%>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident),
         rrm_mois_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        month(date_fin_reponse)==month_ref,1,0))%>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_mensuelle_encours=sum(rrm_mois_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_mois_encours_mois <-left_join(summary_rrm_mois_encours_mois,summary_alerte_rrm_mois%>%select(annee_incident,mois_incident,nb_alerte_sans_rrm),by=c("annee_incident","mois_incident"))

```

```{r }

summary_rrm_mois_encours_mois %>%
  dplyr::select(annee_incident, mois_incident, reponse_mensuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Reponse du mois en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Abris)

```{r }

summary_alerte_rrm_mois %>%
  dplyr::select(annee_incident, mois_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Abris)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_mois <- df_mois %>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, mois_num, mois) %>%
  arrange(annee, mois_num) %>%
  select(-mois_num) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Abris)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_mois<-df_rrm%>%
    filter(uuid %in% rrm_abris_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,bailleur_reponse)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_bailleurs_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Abris)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_mois<-df_rrm%>%
    filter(uuid %in% rrm_abris_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,Acteur)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_acteur_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### BNA

#### Alertes validées par type (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_mois<-df_alerte_bna%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,type_crise)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_type_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_mois<-df_alerte_bna%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,region_arrivee)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_region_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_mois <-df_rrm_bna%>%
  filter(date_fin_reponse>=date_periode_prec_month&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_mois <-df_rrm_for_analysis_mois%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_bna) > 0) {
df_rrm_bna$me=NA

rrm_reshaped_mois <- process_response_data(
  df_rrm_bna,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_BNA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_bna<-df_rrm_bna%>%select(-me)

rrm_reshaped_mois<-rrm_reshaped_mois%>%select(-me)
} else {
  rrm_reshaped_mois <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_mois <- df_alerte_bna %>% left_join(rrm_reshaped_mois, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_mois <- df_mois %>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_mois_encours_mois<-df_mois%>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident),
         rrm_mois_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        month(date_fin_reponse)==month_ref,1,0))%>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_mensuelle_encours=sum(rrm_mois_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_mois_encours_mois <-left_join(summary_rrm_mois_encours_mois,summary_alerte_rrm_mois%>%select(annee_incident,mois_incident,nb_alerte_sans_rrm),by=c("annee_incident","mois_incident"))

```

```{r }

summary_rrm_mois_encours_mois %>%
  dplyr::select(annee_incident, mois_incident, reponse_mensuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Reponse du mois en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (BNA)

```{r }

summary_alerte_rrm_mois %>%
  dplyr::select(annee_incident, mois_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (BNA)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_mois <- df_mois %>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, mois_num, mois) %>%
  arrange(annee, mois_num) %>%
  select(-mois_num) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (BNA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_mois<-df_rrm%>%
    filter(uuid %in% rrm_bna_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,bailleur_reponse)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_bailleurs_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (BNA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_mois<-df_rrm%>%
    filter(uuid %in% rrm_bna_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,Acteur)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_acteur_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Education

#### Alertes validées par type (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_mois<-df_alerte_education%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,type_crise)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_type_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_mois<-df_alerte_education%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,region_arrivee)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_region_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_mois <-df_rrm_education%>%
  filter(date_fin_reponse>=date_periode_prec_month&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_mois <-df_rrm_for_analysis_mois%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_education) > 0) {
df_rrm_education$me=NA

rrm_reshaped_mois <- process_response_data(
  df_rrm_education,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Education",
  nfi_response = "reponse_Education",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_education<-df_rrm_education%>%select(-me)

rrm_reshaped_mois<-rrm_reshaped_mois%>%select(-me)
} else {
  rrm_reshaped_mois <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)

}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_mois <- df_alerte_education %>% left_join(rrm_reshaped_mois, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

summary_alerte_rrm_mois <- df_mois %>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_mois_encours_mois<-df_mois%>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident),
         rrm_mois_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        month(date_fin_reponse)==month_ref,1,0))%>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_mensuelle_encours=sum(rrm_mois_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_mois_encours_mois <-left_join(summary_rrm_mois_encours_mois,summary_alerte_rrm_mois%>%select(annee_incident,mois_incident,nb_alerte_sans_rrm),by=c("annee_incident","mois_incident"))

```

```{r }

summary_rrm_mois_encours_mois %>%
  dplyr::select(annee_incident, mois_incident, reponse_mensuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Reponse du mois en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Education)

```{r }

summary_alerte_rrm_mois %>%
  dplyr::select(annee_incident, mois_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Education)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_mois <- df_mois %>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, mois_num, mois) %>%
  arrange(annee, mois_num) %>%
  select(-mois_num) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Education)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_mois<-df_rrm%>%
    filter(uuid %in% rrm_education_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,bailleur_reponse)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_bailleurs_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Education)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_mois<-df_rrm%>%
    filter(uuid %in% rrm_education_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,Acteur)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_acteur_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Santé

#### Alertes validées par type (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_mois<-df_alerte_sante%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,type_crise)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_type_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_mois<-df_alerte_sante%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,region_arrivee)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_region_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_mois <-df_rrm_sante%>%
  filter(date_fin_reponse>=date_periode_prec_month&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_mois <-df_rrm_for_analysis_mois%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_sante) > 0) {
df_rrm_sante$me=NA

rrm_reshaped_mois <- process_response_data(
  df_rrm_sante,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Santé",
  nfi_response = "reponse_Santé",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_sante<-df_rrm_sante%>%select(-me)

rrm_reshaped_mois<-rrm_reshaped_mois%>%select(-me)
} else {
  rrm_reshaped_mois <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_mois <- df_alerte_sante %>% left_join(rrm_reshaped_mois, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_mois <- df_mois %>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_mois_encours_mois<-df_mois%>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident),
         rrm_mois_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        month(date_fin_reponse)==month_ref,1,0))%>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_mensuelle_encours=sum(rrm_mois_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_mois_encours_mois <-left_join(summary_rrm_mois_encours_mois,summary_alerte_rrm_mois%>%select(annee_incident,mois_incident,nb_alerte_sans_rrm),by=c("annee_incident","mois_incident"))

```

```{r }

summary_rrm_mois_encours_mois %>%
  dplyr::select(annee_incident, mois_incident, reponse_mensuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Reponse du mois en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Santé)

```{r }

summary_alerte_rrm_mois %>%
  dplyr::select(annee_incident, mois_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Santé)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_mois <- df_mois %>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, mois_num, mois) %>%
  arrange(annee, mois_num) %>%
  select(-mois_num) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Santé)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_mois<-df_rrm%>%
    filter(uuid %in% rrm_sante_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,bailleur_reponse)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_bailleurs_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Santé)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_mois<-df_rrm%>%
    filter(uuid %in% rrm_sante_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,Acteur)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_acteur_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Protection

#### Alertes validées par type (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_mois<-df_alerte_protection%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,type_crise)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_type_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_mois<-df_alerte_protection%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,region_arrivee)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_region_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_mois <-df_rrm_protection%>%
  filter(date_fin_reponse>=date_periode_prec_month&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_mois <-df_rrm_for_analysis_mois%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_protection) > 0) {
df_rrm_protection$me=NA

rrm_reshaped_mois <- process_response_data(
  df_rrm_protection,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Protection",
  nfi_response = "reponse_Protection",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_protection<-df_rrm_protection%>%select(-me)

rrm_reshaped_mois<-rrm_reshaped_mois%>%select(-me)
} else {
  rrm_reshaped_mois <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
) 
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_mois <- df_alerte_protection %>% left_join(rrm_reshaped_mois, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_mois <- df_mois %>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_mois_encours_mois<-df_mois%>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident),
         rrm_mois_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        month(date_fin_reponse)==month_ref,1,0))%>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_mensuelle_encours=sum(rrm_mois_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_mois_encours_mois <-left_join(summary_rrm_mois_encours_mois,summary_alerte_rrm_mois%>%select(annee_incident,mois_incident,nb_alerte_sans_rrm),by=c("annee_incident","mois_incident"))

```

```{r }

summary_rrm_mois_encours_mois %>%
  dplyr::select(annee_incident, mois_incident, reponse_mensuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Reponse du mois en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Protection)

```{r }

summary_alerte_rrm_mois %>%
  dplyr::select(annee_incident, mois_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Protection)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_mois <- df_mois %>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, mois_num, mois) %>%
  arrange(annee, mois_num) %>%
  select(-mois_num) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Protection)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_mois<-df_rrm%>%
    filter(uuid %in% rrm_protection_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
   group_by(annee_alerte,mois_num,mois,bailleur_reponse)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_bailleurs_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Protection)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_mois<-df_rrm%>%
    filter(uuid %in% rrm_protection_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,mois_num,mois,Acteur)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_acteur_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### MHM

#### Alertes validées par type (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_mois<-df_alerte_mhm%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,type_crise)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_type_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_mois<-df_alerte_mhm%>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,mois_num,mois,region_arrivee)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_alert_by_region_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_mois <-df_rrm_mhm%>%
  filter(date_fin_reponse>=date_periode_prec_month&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_mois <-df_rrm_for_analysis_mois%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_mhm) > 0) {
df_rrm_mhm$me=NA

rrm_reshaped_mois <- process_response_data(
  df_rrm_mhm,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_MHM",
  nfi_response = "reponse_MHM",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_mhm<-df_rrm_mhm%>%select(-me)

rrm_reshaped_mois<-rrm_reshaped_mois%>%select(-me)
} else {
  rrm_reshaped_mois <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
) 
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_mois <- df_alerte_mhm %>% left_join(rrm_reshaped_mois, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_mois <- df_mois %>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_mois_encours_mois<-df_mois%>%
  mutate(mois_incident = format(date_incident, "%B"),
         annee_incident = year(date_incident),
         rrm_mois_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        month(date_fin_reponse)==month_ref,1,0))%>%
  group_by(annee_incident, mois_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_mensuelle_encours=sum(rrm_mois_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_mois_encours_mois <-left_join(summary_rrm_mois_encours_mois,summary_alerte_rrm_mois%>%select(annee_incident,mois_incident,nb_alerte_sans_rrm),by=c("annee_incident","mois_incident"))

```

```{r }

summary_rrm_mois_encours_mois %>%
  dplyr::select(annee_incident, mois_incident, reponse_mensuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Reponse du mois en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (MHM)

```{r }

summary_alerte_rrm_mois %>%
  dplyr::select(annee_incident, mois_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "mois", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (MHM)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_mois <- df_mois %>%
  mutate(mois = format(date_incident, "%B"), 
        mois_num     = month(date_incident),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, mois_num, mois) %>%
  arrange(annee, mois_num) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)|> 
  select(-mois_num)
```


```{r }
summary_response_time_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (MHM)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_mois<-df_rrm%>%
    filter(uuid %in% rrm_mhm_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,mois_num, mois,bailleur_reponse)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num)
```

```{r }
summary_rrm_by_bailleurs_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (MHM)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_mois<-df_rrm%>%
    filter(uuid %in% rrm_mhm_uuid) |>
  mutate(mois = format(date_fin_reponse, "%B"),
         mois_num= month(date_fin_reponse),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,mois_num, mois,bailleur_reponse)%>%
  arrange(annee_alerte,mois_num)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref) |> 
  ungroup() |> 
  select(-mois_num) 
```

```{r }
summary_rrm_by_acteur_mois %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_mois)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

:::

## Analyse bimensuelle
::: {.panel-tabset}

### Tous secteurs 

#### Alertes validées par type

```{r alert_type_bim, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_bim<-df_alerte%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r plot_alert_type_bim}
summary_alert_by_type_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region

```{r alert_region_bim, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_bim<-df_alerte%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r plot_alert_region_bim}
summary_alert_by_region_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite

```{r alert_modality_bim, echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_bim <-df_rrm%>%
  filter(date_fin_reponse>=date_periode_prec_bim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_bim <-df_rrm_for_analysis_bim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r plot_alert_modality_bim}
summary_reponse_by_modalite_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM

```{r data_reshape_bim, echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm) > 0) {

df_rrm$me=NA

rrm_reshaped_bim <- process_response_data(
  df_rrm,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm<-df_rrm%>%select(-me)

rrm_reshaped_bim<-rrm_reshaped_bim%>%select(-me)
} else {
rrm_reshaped_bim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r data_reshape_2_bim, echo=FALSE, message=FALSE, warning=FALSE }

 df_bim <- df_alerte %>% left_join(rrm_reshaped_bim, by=join_by(uuid == uuid))

```

```{r alert_rrm_bim, echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_bim <- df_bim %>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r rrm_in_process_bim, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_bimestre_encours_bim<-df_bim%>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_bimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_bimestre(date_fin_reponse)==bim_ref,1,0))%>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_bimestrielle_encours=sum(rrm_bimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_bimestre_encours_bim <-left_join(summary_rrm_bimestre_encours_bim,summary_alerte_rrm_bim%>%select(annee_incident,bimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","bimestre_incident"))

```

```{r plot_rrm_in_process_bim}

summary_rrm_bimestre_encours_bim %>%
  dplyr::select(annee_incident, bimestre_incident, reponse_bimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Reponse du bimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées

```{r cumulated_alert_bim}

summary_alerte_rrm_bim %>%
  dplyr::select(annee_incident, bimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median

```{r median_time_bim,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_bim <- df_bim %>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, bimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r plot_median_time_bim}
summary_response_time_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_bim<-df_rrm%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r donor_rrm_bim}
summary_rrm_by_bailleurs_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_bim<-df_rrm%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r plot_donor_rrm_bim}
summary_rrm_by_acteur_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Vivres

#### Alertes validées par type (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_bim<-df_alerte_vivres%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_bim<-df_alerte_vivres%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_bim <-df_rrm_vivres%>%
  filter(date_fin_reponse>=date_periode_prec_bim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_bim <-df_rrm_for_analysis_bim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_vivres) > 0) {

df_rrm_vivres$me=NA

rrm_reshaped_bim <- process_response_data(
  df_rrm_vivres,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_vivres<-df_rrm_vivres%>%select(-me)

rrm_reshaped_bim<-rrm_reshaped_bim%>%select(-me)
} else {
  rrm_reshaped_bim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_bim <- df_alerte_vivres %>% left_join(rrm_reshaped_bim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_bim <- df_bim %>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_bimestre_encours_bim<-df_bim%>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_bimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_bimestre(date_fin_reponse)==bim_ref,1,0))%>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_bimestrielle_encours=sum(rrm_bimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_bimestre_encours_bim <-left_join(summary_rrm_bimestre_encours_bim,summary_alerte_rrm_bim%>%select(annee_incident,bimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","bimestre_incident"))

```

```{r }

summary_rrm_bimestre_encours_bim %>%
  dplyr::select(annee_incident, bimestre_incident, reponse_bimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Reponse du bimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Vivres)

```{r }

summary_alerte_rrm_bim %>%
  dplyr::select(annee_incident, bimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Vivres)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_bim <- df_bim %>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, bimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Vivres)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_bim<-df_rrm%>%
    filter(uuid %in% rrm_vivres_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Vivres)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_bim<-df_rrm%>%
    filter(uuid %in% rrm_vivres_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Nutrition

#### Alertes validées par type (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_bim<-df_alerte_nutrition%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_bim<-df_alerte_nutrition%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_bim <-df_rrm_nutrition%>%
  filter(date_fin_reponse>=date_periode_prec_bim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_bim <-df_rrm_for_analysis_bim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_nutrition) > 0) {
df_rrm_nutrition$me=NA

rrm_reshaped_bim <- process_response_data(
  df_rrm_nutrition,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_nutrition<-df_rrm_nutrition%>%select(-me)

rrm_reshaped_bim<-rrm_reshaped_bim%>%select(-me)
} else {
  rrm_reshaped_bim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_bim <- df_alerte_nutrition %>% left_join(rrm_reshaped_bim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_bim <- df_bim %>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_bimestre_encours_bim<-df_bim%>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_bimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_bimestre(date_fin_reponse)==bim_ref,1,0))%>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_bimestrielle_encours=sum(rrm_bimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_bimestre_encours_bim <-left_join(summary_rrm_bimestre_encours_bim,summary_alerte_rrm_bim%>%select(annee_incident,bimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","bimestre_incident"))

```

```{r }

summary_rrm_bimestre_encours_bim %>%
  dplyr::select(annee_incident, bimestre_incident, reponse_bimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Reponse du bimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Nutrition)

```{r }

summary_alerte_rrm_bim %>%
  dplyr::select(annee_incident, bimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Nutrition)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_bim <- df_bim %>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, bimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Nutrition)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_bim<-df_rrm%>%
    filter(uuid %in% rrm_nutrition_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Nutrition)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_bim<-df_rrm%>%
    filter(uuid %in% rrm_nutrition_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### EHA

#### Alertes validées par type (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_bim<-df_alerte_eha%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_bim<-df_alerte_eha%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_bim <-df_rrm_eha%>%
  filter(date_fin_reponse>=date_periode_prec_bim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_bim <-df_rrm_for_analysis_bim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_eha) > 0) {
df_rrm_eha$me=NA

rrm_reshaped_bim <- process_response_data(
  df_rrm_eha,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_eha<-df_rrm_eha%>%select(-me)

rrm_reshaped_bim<-rrm_reshaped_bim%>%select(-me)
} else {
  rrm_reshaped_bim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_bim <- df_alerte_eha %>% left_join(rrm_reshaped_bim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_bim <- df_bim %>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_bimestre_encours_bim<-df_bim%>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_bimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_bimestre(date_fin_reponse)==bim_ref,1,0))%>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_bimestrielle_encours=sum(rrm_bimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_bimestre_encours_bim <-left_join(summary_rrm_bimestre_encours_bim,summary_alerte_rrm_bim%>%select(annee_incident,bimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","bimestre_incident"))

```

```{r }

summary_rrm_bimestre_encours_bim %>%
  dplyr::select(annee_incident, bimestre_incident, reponse_bimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Reponse du bimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (EHA)

```{r }

summary_alerte_rrm_bim %>%
  dplyr::select(annee_incident, bimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (EHA)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_bim <- df_bim %>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, bimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (EHA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_bim<-df_rrm%>%
    filter(uuid %in% rrm_eha_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (EHA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_bim<-df_rrm%>%
    filter(uuid %in% rrm_eha_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Abris

#### Alertes validées par type (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_bim<-df_alerte_abris%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_bim<-df_alerte_abris%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_bim <-df_rrm_abris%>%
  filter(date_fin_reponse>=date_periode_prec_bim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_bim <-df_rrm_for_analysis_bim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_abris) > 0) {
df_rrm_abris$me=NA

rrm_reshaped_bim <- process_response_data(
  df_rrm_abris,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Abris",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_abris<-df_rrm_abris%>%select(-me)

rrm_reshaped_bim<-rrm_reshaped_bim%>%select(-me)
} else {
  rrm_reshaped_bim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_Abris        = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_bim <- df_alerte_abris %>% left_join(rrm_reshaped_bim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_bim <- df_bim %>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_bimestre_encours_bim<-df_bim%>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_bimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_bimestre(date_fin_reponse)==bim_ref,1,0))%>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_bimestrielle_encours=sum(rrm_bimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_bimestre_encours_bim <-left_join(summary_rrm_bimestre_encours_bim,summary_alerte_rrm_bim%>%select(annee_incident,bimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","bimestre_incident"))

```

```{r }

summary_rrm_bimestre_encours_bim %>%
  dplyr::select(annee_incident, bimestre_incident, reponse_bimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Reponse du bimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Abris)

```{r }

summary_alerte_rrm_bim %>%
  dplyr::select(annee_incident, bimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Abris)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_bim <- df_bim %>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, bimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Abris)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_bim<-df_rrm%>%
    filter(uuid %in% rrm_abris_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Abris)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_bim<-df_rrm%>%
    filter(uuid %in% rrm_abris_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### BNA

#### Alertes validées par type (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_bim<-df_alerte_bna%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_bim<-df_alerte_bna%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_bim <-df_rrm_bna%>%
  filter(date_fin_reponse>=date_periode_prec_bim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_bim <-df_rrm_for_analysis_bim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_bna) > 0) {
df_rrm_bna$me=NA

rrm_reshaped_bim <- process_response_data(
  df_rrm_bna,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_BNA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_bna<-df_rrm_bna%>%select(-me)

rrm_reshaped_bim<-rrm_reshaped_bim%>%select(-me)
} else {
  rrm_reshaped_bim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_bim <- df_alerte_bna %>% left_join(rrm_reshaped_bim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_bim <- df_bim %>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_bimestre_encours_bim<-df_bim%>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_bimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_bimestre(date_fin_reponse)==bim_ref,1,0))%>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_bimestrielle_encours=sum(rrm_bimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_bimestre_encours_bim <-left_join(summary_rrm_bimestre_encours_bim,summary_alerte_rrm_bim%>%select(annee_incident,bimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","bimestre_incident"))

```

```{r }

summary_rrm_bimestre_encours_bim %>%
  dplyr::select(annee_incident, bimestre_incident, reponse_bimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Reponse du bimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (BNA)

```{r }

summary_alerte_rrm_bim %>%
  dplyr::select(annee_incident, bimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (BNA)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_bim <- df_bim %>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, bimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (BNA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_bim<-df_rrm%>%
    filter(uuid %in% rrm_bna_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (BNA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_bim<-df_rrm%>%
    filter(uuid %in% rrm_bna_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Education

#### Alertes validées par type (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_bim<-df_alerte_education%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_bim<-df_alerte_education%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_bim <-df_rrm_education%>%
  filter(date_fin_reponse>=date_periode_prec_bim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_bim <-df_rrm_for_analysis_bim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_education) > 0) {
df_rrm_education$me=NA

rrm_reshaped_bim <- process_response_data(
  df_rrm_education,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Education",
  nfi_response = "reponse_Education",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_education<-df_rrm_education%>%select(-me)

rrm_reshaped_bim<-rrm_reshaped_bim%>%select(-me)
} else {
  rrm_reshaped_bim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)

}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_bim <- df_alerte_education %>% left_join(rrm_reshaped_bim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

summary_alerte_rrm_bim <- df_bim %>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_bimestre_encours_bim<-df_bim%>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_bimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_bimestre(date_fin_reponse)==bim_ref,1,0))%>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_bimestrielle_encours=sum(rrm_bimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_bimestre_encours_bim <-left_join(summary_rrm_bimestre_encours_bim,summary_alerte_rrm_bim%>%select(annee_incident,bimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","bimestre_incident"))

```

```{r }

summary_rrm_bimestre_encours_bim %>%
  dplyr::select(annee_incident, bimestre_incident, reponse_bimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Reponse du bimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Education)

```{r }

summary_alerte_rrm_bim %>%
  dplyr::select(annee_incident, bimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Education)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_bim <- df_bim %>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, bimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Education)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_bim<-df_rrm%>%
    filter(uuid %in% rrm_education_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Education)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_bim<-df_rrm%>%
    filter(uuid %in% rrm_education_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Santé

#### Alertes validées par type (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_bim<-df_alerte_sante%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_bim<-df_alerte_sante%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_bim <-df_rrm_sante%>%
  filter(date_fin_reponse>=date_periode_prec_bim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_bim <-df_rrm_for_analysis_bim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_sante) > 0) {
df_rrm_sante$me=NA

rrm_reshaped_bim <- process_response_data(
  df_rrm_sante,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Santé",
  nfi_response = "reponse_Santé",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_sante<-df_rrm_sante%>%select(-me)

rrm_reshaped_bim<-rrm_reshaped_bim%>%select(-me)
} else {
  rrm_reshaped_bim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_bim <- df_alerte_sante %>% left_join(rrm_reshaped_bim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_bim <- df_bim %>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_bimestre_encours_bim<-df_bim%>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_bimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_bimestre(date_fin_reponse)==bim_ref,1,0))%>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_bimestrielle_encours=sum(rrm_bimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_bimestre_encours_bim <-left_join(summary_rrm_bimestre_encours_bim,summary_alerte_rrm_bim%>%select(annee_incident,bimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","bimestre_incident"))

```

```{r }

summary_rrm_bimestre_encours_bim %>%
  dplyr::select(annee_incident, bimestre_incident, reponse_bimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Reponse du bimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Santé)

```{r }

summary_alerte_rrm_bim %>%
  dplyr::select(annee_incident, bimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Santé)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_bim <- df_bim %>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, bimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Santé)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_bim<-df_rrm%>%
    filter(uuid %in% rrm_sante_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Santé)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_bim<-df_rrm%>%
    filter(uuid %in% rrm_sante_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Protection

#### Alertes validées par type (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_bim<-df_alerte_protection%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_bim<-df_alerte_protection%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_bim <-df_rrm_protection%>%
  filter(date_fin_reponse>=date_periode_prec_bim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_bim <-df_rrm_for_analysis_bim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_protection) > 0) {
df_rrm_protection$me=NA

rrm_reshaped_bim <- process_response_data(
  df_rrm_protection,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Protection",
  nfi_response = "reponse_Protection",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_protection<-df_rrm_protection%>%select(-me)

rrm_reshaped_bim<-rrm_reshaped_bim%>%select(-me)
} else {
  rrm_reshaped_bim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
) 
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_bim <- df_alerte_protection %>% left_join(rrm_reshaped_bim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_bim <- df_bim %>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_bimestre_encours_bim<-df_bim%>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_bimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_bimestre(date_fin_reponse)==bim_ref,1,0))%>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_bimestrielle_encours=sum(rrm_bimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_bimestre_encours_bim <-left_join(summary_rrm_bimestre_encours_bim,summary_alerte_rrm_bim%>%select(annee_incident,bimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","bimestre_incident"))

```

```{r }

summary_rrm_bimestre_encours_bim %>%
  dplyr::select(annee_incident, bimestre_incident, reponse_bimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Reponse du bimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Protection)

```{r }

summary_alerte_rrm_bim %>%
  dplyr::select(annee_incident, bimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Protection)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_bim <- df_bim %>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, bimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Protection)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_bim<-df_rrm%>%
    filter(uuid %in% rrm_protection_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Protection)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_bim<-df_rrm%>%
    filter(uuid %in% rrm_protection_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### MHM

#### Alertes validées par type (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_bim<-df_alerte_mhm%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_bim<-df_alerte_mhm%>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,bimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_bim <-df_rrm_mhm%>%
  filter(date_fin_reponse>=date_periode_prec_bim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_bim <-df_rrm_for_analysis_bim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_mhm) > 0) {
df_rrm_mhm$me=NA

rrm_reshaped_bim <- process_response_data(
  df_rrm_mhm,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_MHM",
  nfi_response = "reponse_MHM",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_mhm<-df_rrm_mhm%>%select(-me)

rrm_reshaped_bim<-rrm_reshaped_bim%>%select(-me)
} else {
  rrm_reshaped_bim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
) 
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_bim <- df_alerte_mhm %>% left_join(rrm_reshaped_bim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_bim <- df_bim %>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_bimestre_encours_bim<-df_bim%>%
  mutate(bimestre_incident = paste0("bimestre ", get_bimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_bimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_bimestre(date_fin_reponse)==bim_ref,1,0))%>%
  group_by(annee_incident, bimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_bimestrielle_encours=sum(rrm_bimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_bimestre_encours_bim <-left_join(summary_rrm_bimestre_encours_bim,summary_alerte_rrm_bim%>%select(annee_incident,bimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","bimestre_incident"))

```

```{r }

summary_rrm_bimestre_encours_bim %>%
  dplyr::select(annee_incident, bimestre_incident, reponse_bimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Reponse du bimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (MHM)

```{r }

summary_alerte_rrm_bim %>%
  dplyr::select(annee_incident, bimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "bimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (MHM)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_bim <- df_bim %>%
  mutate(bimestre = paste0("Bim ", get_bimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, bimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (MHM)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_bim<-df_rrm%>%
    filter(uuid %in% rrm_mhm_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (MHM)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_bim<-df_rrm%>%
    filter(uuid %in% rrm_mhm_uuid) |>
  mutate(bimestre = paste0("Bim ", get_bimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_bim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_bim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

:::

## Analyse trimestrielle

::: {.panel-tabset}
### Tous secteurs 

#### Alertes validées par type

```{r alert_type_trim, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_trim<-df_alerte%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r plot_alert_type_trim}
summary_alert_by_type_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region

```{r alert_region_trim, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_trim<-df_alerte%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r plot_alert_region_trim}
summary_alert_by_region_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite

```{r alert_modality_trim, echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_trim <-df_rrm%>%
  filter(date_fin_reponse>=date_periode_prec_trim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_trim <-df_rrm_for_analysis_trim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r plot_alert_modality_trim}
summary_reponse_by_modalite_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM

```{r data_reshape_trim, echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm) > 0) {

df_rrm$me=NA

rrm_reshaped_trim <- process_response_data(
  df_rrm,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm<-df_rrm%>%select(-me)

rrm_reshaped_trim<-rrm_reshaped_trim%>%select(-me)
} else {
rrm_reshaped_trim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r data_reshape_2_trim, echo=FALSE, message=FALSE, warning=FALSE }

 df_trim <- df_alerte %>% left_join(rrm_reshaped_trim, by=join_by(uuid == uuid))

```

```{r alert_rrm_trim, echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_trim <- df_trim %>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r rrm_in_process_trim, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_trimestre_encours_trim<-df_trim%>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_trimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_trimestre(date_fin_reponse)==quarter_ref,1,0))%>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_trimestrielle_encours=sum(rrm_trimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_trimestre_encours_trim <-left_join(summary_rrm_trimestre_encours_trim,summary_alerte_rrm_trim%>%select(annee_incident,trimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","trimestre_incident"))

```

```{r plot_rrm_in_process_trim}

summary_rrm_trimestre_encours_trim %>%
  dplyr::select(annee_incident, trimestre_incident, reponse_trimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Reponse du trimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées

```{r cumulated_alert_trim}

summary_alerte_rrm_trim %>%
  dplyr::select(annee_incident, trimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median

```{r median_time_trim,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_trim <- df_trim %>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, trimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r plot_median_time_trim}
summary_response_time_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_trim<-df_rrm%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r donor_rrm_trim}
summary_rrm_by_bailleurs_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_trim<-df_rrm%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r plot_donor_rrm_trim}
summary_rrm_by_acteur_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Vivres

#### Alertes validées par type (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_trim<-df_alerte_vivres%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_trim<-df_alerte_vivres%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_trim <-df_rrm_vivres%>%
  filter(date_fin_reponse>=date_periode_prec_trim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_trim <-df_rrm_for_analysis_trim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_vivres) > 0) {

df_rrm_vivres$me=NA

rrm_reshaped_trim <- process_response_data(
  df_rrm_vivres,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_vivres<-df_rrm_vivres%>%select(-me)

rrm_reshaped_trim<-rrm_reshaped_trim%>%select(-me)
} else {
  rrm_reshaped_trim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_trim <- df_alerte_vivres %>% left_join(rrm_reshaped_trim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_trim <- df_trim %>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_trimestre_encours_trim<-df_trim%>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_trimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_trimestre(date_fin_reponse)==quarter_ref,1,0))%>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_trimestrielle_encours=sum(rrm_trimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_trimestre_encours_trim <-left_join(summary_rrm_trimestre_encours_trim,summary_alerte_rrm_trim%>%select(annee_incident,trimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","trimestre_incident"))

```

```{r }

summary_rrm_trimestre_encours_trim %>%
  dplyr::select(annee_incident, trimestre_incident, reponse_trimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Reponse du trimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Vivres)

```{r }

summary_alerte_rrm_trim %>%
  dplyr::select(annee_incident, trimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Vivres)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_trim <- df_trim %>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, trimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Vivres)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_trim<-df_rrm%>%
    filter(uuid %in% rrm_vivres_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Vivres)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_trim<-df_rrm%>%
    filter(uuid %in% rrm_vivres_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Nutrition

#### Alertes validées par type (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_trim<-df_alerte_nutrition%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_trim<-df_alerte_nutrition%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_trim <-df_rrm_nutrition%>%
  filter(date_fin_reponse>=date_periode_prec_trim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_trim <-df_rrm_for_analysis_trim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_nutrition) > 0) {
df_rrm_nutrition$me=NA

rrm_reshaped_trim <- process_response_data(
  df_rrm_nutrition,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_nutrition<-df_rrm_nutrition%>%select(-me)

rrm_reshaped_trim<-rrm_reshaped_trim%>%select(-me)
} else {
  rrm_reshaped_trim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_trim <- df_alerte_nutrition %>% left_join(rrm_reshaped_trim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_trim <- df_trim %>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_trimestre_encours_trim<-df_trim%>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_trimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_trimestre(date_fin_reponse)==quarter_ref,1,0))%>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_trimestrielle_encours=sum(rrm_trimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_trimestre_encours_trim <-left_join(summary_rrm_trimestre_encours_trim,summary_alerte_rrm_trim%>%select(annee_incident,trimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","trimestre_incident"))

```

```{r }

summary_rrm_trimestre_encours_trim %>%
  dplyr::select(annee_incident, trimestre_incident, reponse_trimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Reponse du trimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Nutrition)

```{r }

summary_alerte_rrm_trim %>%
  dplyr::select(annee_incident, trimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Nutrition)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_trim <- df_trim %>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, trimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Nutrition)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_trim<-df_rrm%>%
    filter(uuid %in% rrm_nutrition_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Nutrition)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_trim<-df_rrm%>%
    filter(uuid %in% rrm_nutrition_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### EHA

#### Alertes validées par type (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_trim<-df_alerte_eha%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_trim<-df_alerte_eha%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_trim <-df_rrm_eha%>%
  filter(date_fin_reponse>=date_periode_prec_trim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_trim <-df_rrm_for_analysis_trim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_eha) > 0) {
df_rrm_eha$me=NA

rrm_reshaped_trim <- process_response_data(
  df_rrm_eha,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_eha<-df_rrm_eha%>%select(-me)

rrm_reshaped_trim<-rrm_reshaped_trim%>%select(-me)
} else {
  rrm_reshaped_trim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_trim <- df_alerte_eha %>% left_join(rrm_reshaped_trim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_trim <- df_trim %>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_trimestre_encours_trim<-df_trim%>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_trimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_trimestre(date_fin_reponse)==quarter_ref,1,0))%>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_trimestrielle_encours=sum(rrm_trimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_trimestre_encours_trim <-left_join(summary_rrm_trimestre_encours_trim,summary_alerte_rrm_trim%>%select(annee_incident,trimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","trimestre_incident"))

```

```{r }

summary_rrm_trimestre_encours_trim %>%
  dplyr::select(annee_incident, trimestre_incident, reponse_trimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Reponse du trimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (EHA)

```{r }

summary_alerte_rrm_trim %>%
  dplyr::select(annee_incident, trimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (EHA)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_trim <- df_trim %>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, trimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (EHA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_trim<-df_rrm%>%
    filter(uuid %in% rrm_eha_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (EHA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_trim<-df_rrm%>%
    filter(uuid %in% rrm_eha_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Abris

#### Alertes validées par type (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_trim<-df_alerte_abris%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_trim<-df_alerte_abris%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_trim <-df_rrm_abris%>%
  filter(date_fin_reponse>=date_periode_prec_trim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_trim <-df_rrm_for_analysis_trim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_abris) > 0) {
df_rrm_abris$me=NA

rrm_reshaped_trim <- process_response_data(
  df_rrm_abris,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Abris",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_abris<-df_rrm_abris%>%select(-me)

rrm_reshaped_trim<-rrm_reshaped_trim%>%select(-me)
} else {
  rrm_reshaped_trim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_Abris        = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_trim <- df_alerte_abris %>% left_join(rrm_reshaped_trim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_trim <- df_trim %>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_trimestre_encours_trim<-df_trim%>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_trimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_trimestre(date_fin_reponse)==quarter_ref,1,0))%>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_trimestrielle_encours=sum(rrm_trimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_trimestre_encours_trim <-left_join(summary_rrm_trimestre_encours_trim,summary_alerte_rrm_trim%>%select(annee_incident,trimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","trimestre_incident"))

```

```{r }

summary_rrm_trimestre_encours_trim %>%
  dplyr::select(annee_incident, trimestre_incident, reponse_trimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Reponse du trimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Abris)

```{r }

summary_alerte_rrm_trim %>%
  dplyr::select(annee_incident, trimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Abris)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_trim <- df_trim %>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, trimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Abris)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_trim<-df_rrm%>%
    filter(uuid %in% rrm_abris_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Abris)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_trim<-df_rrm%>%
    filter(uuid %in% rrm_abris_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### BNA

#### Alertes validées par type (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_trim<-df_alerte_bna%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_trim<-df_alerte_bna%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_trim <-df_rrm_bna%>%
  filter(date_fin_reponse>=date_periode_prec_trim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_trim <-df_rrm_for_analysis_trim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_bna) > 0) {
df_rrm_bna$me=NA

rrm_reshaped_trim <- process_response_data(
  df_rrm_bna,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_BNA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_bna<-df_rrm_bna%>%select(-me)

rrm_reshaped_trim<-rrm_reshaped_trim%>%select(-me)
} else {
  rrm_reshaped_trim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_trim <- df_alerte_bna %>% left_join(rrm_reshaped_trim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_trim <- df_trim %>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_trimestre_encours_trim<-df_trim%>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_trimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_trimestre(date_fin_reponse)==quarter_ref,1,0))%>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_trimestrielle_encours=sum(rrm_trimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_trimestre_encours_trim <-left_join(summary_rrm_trimestre_encours_trim,summary_alerte_rrm_trim%>%select(annee_incident,trimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","trimestre_incident"))

```

```{r }

summary_rrm_trimestre_encours_trim %>%
  dplyr::select(annee_incident, trimestre_incident, reponse_trimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Reponse du trimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (BNA)

```{r }

summary_alerte_rrm_trim %>%
  dplyr::select(annee_incident, trimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (BNA)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_trim <- df_trim %>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, trimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (BNA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_trim<-df_rrm%>%
    filter(uuid %in% rrm_bna_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (BNA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_trim<-df_rrm%>%
    filter(uuid %in% rrm_bna_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Education

#### Alertes validées par type (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_trim<-df_alerte_education%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_trim<-df_alerte_education%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_trim <-df_rrm_education%>%
  filter(date_fin_reponse>=date_periode_prec_trim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_trim <-df_rrm_for_analysis_trim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_education) > 0) {
df_rrm_education$me=NA

rrm_reshaped_trim <- process_response_data(
  df_rrm_education,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Education",
  nfi_response = "reponse_Education",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_education<-df_rrm_education%>%select(-me)

rrm_reshaped_trim<-rrm_reshaped_trim%>%select(-me)
} else {
  rrm_reshaped_trim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)

}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_trim <- df_alerte_education %>% left_join(rrm_reshaped_trim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

summary_alerte_rrm_trim <- df_trim %>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_trimestre_encours_trim<-df_trim%>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_trimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_trimestre(date_fin_reponse)==quarter_ref,1,0))%>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_trimestrielle_encours=sum(rrm_trimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_trimestre_encours_trim <-left_join(summary_rrm_trimestre_encours_trim,summary_alerte_rrm_trim%>%select(annee_incident,trimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","trimestre_incident"))

```

```{r }

summary_rrm_trimestre_encours_trim %>%
  dplyr::select(annee_incident, trimestre_incident, reponse_trimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Reponse du trimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Education)

```{r }

summary_alerte_rrm_trim %>%
  dplyr::select(annee_incident, trimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Education)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_trim <- df_trim %>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, trimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Education)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_trim<-df_rrm%>%
    filter(uuid %in% rrm_education_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Education)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_trim<-df_rrm%>%
    filter(uuid %in% rrm_education_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Santé

#### Alertes validées par type (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_trim<-df_alerte_sante%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_trim<-df_alerte_sante%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_trim <-df_rrm_sante%>%
  filter(date_fin_reponse>=date_periode_prec_trim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_trim <-df_rrm_for_analysis_trim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_sante) > 0) {
df_rrm_sante$me=NA

rrm_reshaped_trim <- process_response_data(
  df_rrm_sante,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Santé",
  nfi_response = "reponse_Santé",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_sante<-df_rrm_sante%>%select(-me)

rrm_reshaped_trim<-rrm_reshaped_trim%>%select(-me)
} else {
  rrm_reshaped_trim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_trim <- df_alerte_sante %>% left_join(rrm_reshaped_trim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_trim <- df_trim %>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_trimestre_encours_trim<-df_trim%>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_trimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_trimestre(date_fin_reponse)==quarter_ref,1,0))%>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_trimestrielle_encours=sum(rrm_trimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_trimestre_encours_trim <-left_join(summary_rrm_trimestre_encours_trim,summary_alerte_rrm_trim%>%select(annee_incident,trimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","trimestre_incident"))

```

```{r }

summary_rrm_trimestre_encours_trim %>%
  dplyr::select(annee_incident, trimestre_incident, reponse_trimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Reponse du trimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Santé)

```{r }

summary_alerte_rrm_trim %>%
  dplyr::select(annee_incident, trimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Santé)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_trim <- df_trim %>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, trimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Santé)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_trim<-df_rrm%>%
    filter(uuid %in% rrm_sante_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Santé)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_trim<-df_rrm%>%
    filter(uuid %in% rrm_sante_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Protection

#### Alertes validées par type (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_trim<-df_alerte_protection%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_trim<-df_alerte_protection%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_trim <-df_rrm_protection%>%
  filter(date_fin_reponse>=date_periode_prec_trim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_trim <-df_rrm_for_analysis_trim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_protection) > 0) {
df_rrm_protection$me=NA

rrm_reshaped_trim <- process_response_data(
  df_rrm_protection,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Protection",
  nfi_response = "reponse_Protection",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_protection<-df_rrm_protection%>%select(-me)

rrm_reshaped_trim<-rrm_reshaped_trim%>%select(-me)
} else {
  rrm_reshaped_trim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
) 
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_trim <- df_alerte_protection %>% left_join(rrm_reshaped_trim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_trim <- df_trim %>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_trimestre_encours_trim<-df_trim%>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_trimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_trimestre(date_fin_reponse)==quarter_ref,1,0))%>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_trimestrielle_encours=sum(rrm_trimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_trimestre_encours_trim <-left_join(summary_rrm_trimestre_encours_trim,summary_alerte_rrm_trim%>%select(annee_incident,trimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","trimestre_incident"))

```

```{r }

summary_rrm_trimestre_encours_trim %>%
  dplyr::select(annee_incident, trimestre_incident, reponse_trimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Reponse du trimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Protection)

```{r }

summary_alerte_rrm_trim %>%
  dplyr::select(annee_incident, trimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Protection)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_trim <- df_trim %>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, trimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Protection)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_trim<-df_rrm%>%
    filter(uuid %in% rrm_protection_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Protection)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_trim<-df_rrm%>%
    filter(uuid %in% rrm_protection_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### MHM

#### Alertes validées par type (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_trim<-df_alerte_mhm%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_trim<-df_alerte_mhm%>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,trimestre,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_trim <-df_rrm_mhm%>%
  filter(date_fin_reponse>=date_periode_prec_trim&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_trim <-df_rrm_for_analysis_trim%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_mhm) > 0) {
df_rrm_mhm$me=NA

rrm_reshaped_trim <- process_response_data(
  df_rrm_mhm,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_MHM",
  nfi_response = "reponse_MHM",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_mhm<-df_rrm_mhm%>%select(-me)

rrm_reshaped_trim<-rrm_reshaped_trim%>%select(-me)
} else {
  rrm_reshaped_trim <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
) 
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_trim <- df_alerte_mhm %>% left_join(rrm_reshaped_trim, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_trim <- df_trim %>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_trimestre_encours_trim<-df_trim%>%
  mutate(trimestre_incident = paste0("trimestre ", get_trimestre(date_incident)),
         annee_incident = year(date_incident),
         rrm_trimestre_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref & 
                                        get_trimestre(date_fin_reponse)==quarter_ref,1,0))%>%
  group_by(annee_incident, trimestre_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_trimestrielle_encours=sum(rrm_trimestre_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_trimestre_encours_trim <-left_join(summary_rrm_trimestre_encours_trim,summary_alerte_rrm_trim%>%select(annee_incident,trimestre_incident,nb_alerte_sans_rrm),by=c("annee_incident","trimestre_incident"))

```

```{r }

summary_rrm_trimestre_encours_trim %>%
  dplyr::select(annee_incident, trimestre_incident, reponse_trimestrielle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Reponse du trimestre en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (MHM)

```{r }

summary_alerte_rrm_trim %>%
  dplyr::select(annee_incident, trimestre_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "trimestre", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (MHM)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_trim <- df_trim %>%
  mutate(trimestre = paste0("Trim ", get_trimestre(date_incident)),
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee, trimestre) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (MHM)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_trim<-df_rrm%>%
    filter(uuid %in% rrm_mhm_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (MHM)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_trim<-df_rrm%>%
    filter(uuid %in% rrm_mhm_uuid) |>
  mutate(trimestre = paste0("Trim ", get_trimestre(date_fin_reponse)),
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,trimestre,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_trim %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_trim)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

:::


## Analyse annuelle

::: {.panel-tabset}
### Tous secteurs 

#### Alertes validées par type

```{r alert_type_ann, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_ann<-df_alerte%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r plot_alert_type_ann}
summary_alert_by_type_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region

```{r alert_region_ann, echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_ann<-df_alerte%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r plot_alert_region_ann}
summary_alert_by_region_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite

```{r alert_modality_ann, echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_ann <-df_rrm%>%
  filter(date_fin_reponse>=date_periode_prec_year&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_ann <-df_rrm_for_analysis_ann%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r plot_alert_modality_ann}
summary_reponse_by_modalite_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM

```{r data_reshape_ann, echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm) > 0) {

df_rrm$me=NA

rrm_reshaped_ann <- process_response_data(
  df_rrm,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm<-df_rrm%>%select(-me)

rrm_reshaped_ann<-rrm_reshaped_ann%>%select(-me)
} else {
rrm_reshaped_ann <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r data_reshape_2_ann, echo=FALSE, message=FALSE, warning=FALSE }

 df_ann <- df_alerte %>% left_join(rrm_reshaped_ann, by=join_by(uuid == uuid))

```

```{r alert_rrm_ann, echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_ann <- df_ann %>%
  mutate(
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r rrm_in_process_ann, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_annee_encours_ann<-df_ann%>%
  mutate(
         annee_incident = year(date_incident),
         rrm_annee_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref,1,0))%>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_annuelle_encours=sum(rrm_annee_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_annee_encours_ann <-left_join(summary_rrm_annee_encours_ann,summary_alerte_rrm_ann%>%select(annee_incident,nb_alerte_sans_rrm),by=c("annee_incident"))

```

```{r plot_rrm_in_process_ann}

summary_rrm_annee_encours_ann %>%
  dplyr::select(annee_incident, reponse_annuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Reponse du annee en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées

```{r cumulated_alert_ann}

summary_alerte_rrm_ann %>%
  dplyr::select(annee_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median

```{r median_time_ann,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_ann <- df_ann %>%
  mutate(
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r plot_median_time_ann}
summary_response_time_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_ann<-df_rrm%>%
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r donor_rrm_ann}
summary_rrm_by_bailleurs_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_ann<-df_rrm%>%
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r plot_donor_rrm_ann}
summary_rrm_by_acteur_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Vivres

#### Alertes validées par type (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_ann<-df_alerte_vivres%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_ann<-df_alerte_vivres%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_ann <-df_rrm_vivres%>%
  filter(date_fin_reponse>=date_periode_prec_year&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_ann <-df_rrm_for_analysis_ann%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Vivres)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_vivres) > 0) {

df_rrm_vivres$me=NA

rrm_reshaped_ann <- process_response_data(
  df_rrm_vivres,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_vivres<-df_rrm_vivres%>%select(-me)

rrm_reshaped_ann<-rrm_reshaped_ann%>%select(-me)
} else {
  rrm_reshaped_ann <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_ann <- df_alerte_vivres %>% left_join(rrm_reshaped_ann, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_ann <- df_ann %>%
  mutate(
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_annee_encours_ann<-df_ann%>%
  mutate(
         annee_incident = year(date_incident),
         rrm_annee_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref,1,0))%>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_annuelle_encours=sum(rrm_annee_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_annee_encours_ann <-left_join(summary_rrm_annee_encours_ann,summary_alerte_rrm_ann%>%select(annee_incident,nb_alerte_sans_rrm),by=c("annee_incident"))

```

```{r }

summary_rrm_annee_encours_ann %>%
  dplyr::select(annee_incident, reponse_annuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Reponse du annee en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Vivres)

```{r }

summary_alerte_rrm_ann %>%
  dplyr::select(annee_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Vivres)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_ann <- df_ann %>%
  mutate(
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Vivres)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_ann<-df_rrm%>%
    filter(uuid %in% rrm_vivres_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Vivres)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_ann<-df_rrm%>%
    filter(uuid %in% rrm_vivres_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Nutrition

#### Alertes validées par type (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_ann<-df_alerte_nutrition%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_ann<-df_alerte_nutrition%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_ann <-df_rrm_nutrition%>%
  filter(date_fin_reponse>=date_periode_prec_year&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_ann <-df_rrm_for_analysis_ann%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Nutrition)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_nutrition) > 0) {
df_rrm_nutrition$me=NA

rrm_reshaped_ann <- process_response_data(
  df_rrm_nutrition,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_nutrition<-df_rrm_nutrition%>%select(-me)

rrm_reshaped_ann<-rrm_reshaped_ann%>%select(-me)
} else {
  rrm_reshaped_ann <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_ann <- df_alerte_nutrition %>% left_join(rrm_reshaped_ann, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_ann <- df_ann %>%
  mutate(
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_annee_encours_ann<-df_ann%>%
  mutate(
         annee_incident = year(date_incident),
         rrm_annee_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref,1,0))%>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_annuelle_encours=sum(rrm_annee_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_annee_encours_ann <-left_join(summary_rrm_annee_encours_ann,summary_alerte_rrm_ann%>%select(annee_incident,nb_alerte_sans_rrm),by=c("annee_incident"))

```

```{r }

summary_rrm_annee_encours_ann %>%
  dplyr::select(annee_incident, reponse_annuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Reponse du annee en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Nutrition)

```{r }

summary_alerte_rrm_ann %>%
  dplyr::select(annee_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Nutrition)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_ann <- df_ann %>%
  mutate(
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Nutrition)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_ann<-df_rrm%>%
    filter(uuid %in% rrm_nutrition_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Nutrition)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_ann<-df_rrm%>%
    filter(uuid %in% rrm_nutrition_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### EHA

#### Alertes validées par type (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_ann<-df_alerte_eha%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_ann<-df_alerte_eha%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_ann <-df_rrm_eha%>%
  filter(date_fin_reponse>=date_periode_prec_year&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_ann <-df_rrm_for_analysis_ann%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (EHA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_eha) > 0) {
df_rrm_eha$me=NA

rrm_reshaped_ann <- process_response_data(
  df_rrm_eha,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_EHA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_eha<-df_rrm_eha%>%select(-me)

rrm_reshaped_ann<-rrm_reshaped_ann%>%select(-me)
} else {
  rrm_reshaped_ann <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_ann <- df_alerte_eha %>% left_join(rrm_reshaped_ann, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_ann <- df_ann %>%
  mutate(
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_annee_encours_ann<-df_ann%>%
  mutate(
         annee_incident = year(date_incident),
         rrm_annee_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref,1,0))%>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_annuelle_encours=sum(rrm_annee_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_annee_encours_ann <-left_join(summary_rrm_annee_encours_ann,summary_alerte_rrm_ann%>%select(annee_incident,nb_alerte_sans_rrm),by=c("annee_incident"))

```

```{r }

summary_rrm_annee_encours_ann %>%
  dplyr::select(annee_incident, reponse_annuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Reponse du annee en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (EHA)

```{r }

summary_alerte_rrm_ann %>%
  dplyr::select(annee_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (EHA)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_ann <- df_ann %>%
  mutate(
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (EHA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_ann<-df_rrm%>%
    filter(uuid %in% rrm_eha_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (EHA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_ann<-df_rrm%>%
    filter(uuid %in% rrm_eha_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Abris

#### Alertes validées par type (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_ann<-df_alerte_abris%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_ann<-df_alerte_abris%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_ann <-df_rrm_abris%>%
  filter(date_fin_reponse>=date_periode_prec_year&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_ann <-df_rrm_for_analysis_ann%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Abris)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_abris) > 0) {
df_rrm_abris$me=NA

rrm_reshaped_ann <- process_response_data(
  df_rrm_abris,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Abris",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_abris<-df_rrm_abris%>%select(-me)

rrm_reshaped_ann<-rrm_reshaped_ann%>%select(-me)
} else {
  rrm_reshaped_ann <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_Abris        = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_ann <- df_alerte_abris %>% left_join(rrm_reshaped_ann, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_ann <- df_ann %>%
  mutate(
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_annee_encours_ann<-df_ann%>%
  mutate(
         annee_incident = year(date_incident),
         rrm_annee_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref,1,0))%>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_annuelle_encours=sum(rrm_annee_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_annee_encours_ann <-left_join(summary_rrm_annee_encours_ann,summary_alerte_rrm_ann%>%select(annee_incident,nb_alerte_sans_rrm),by=c("annee_incident"))

```

```{r }

summary_rrm_annee_encours_ann %>%
  dplyr::select(annee_incident, reponse_annuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Reponse du annee en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Abris)

```{r }

summary_alerte_rrm_ann %>%
  dplyr::select(annee_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Abris)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_ann <- df_ann %>%
  mutate(
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Abris)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_ann<-df_rrm%>%
    filter(uuid %in% rrm_abris_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Abris)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_ann<-df_rrm%>%
    filter(uuid %in% rrm_abris_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### BNA

#### Alertes validées par type (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_ann<-df_alerte_bna%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_ann<-df_alerte_bna%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_ann <-df_rrm_bna%>%
  filter(date_fin_reponse>=date_periode_prec_year&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_ann <-df_rrm_for_analysis_ann%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (BNA)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_bna) > 0) {
df_rrm_bna$me=NA

rrm_reshaped_ann <- process_response_data(
  df_rrm_bna,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_BNA",
  nfi_response = "reponse_BNA",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_bna<-df_rrm_bna%>%select(-me)

rrm_reshaped_ann<-rrm_reshaped_ann%>%select(-me)
} else {
  rrm_reshaped_ann <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_ann <- df_alerte_bna %>% left_join(rrm_reshaped_ann, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_ann <- df_ann %>%
  mutate(
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_annee_encours_ann<-df_ann%>%
  mutate(
         annee_incident = year(date_incident),
         rrm_annee_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref,1,0))%>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_annuelle_encours=sum(rrm_annee_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_annee_encours_ann <-left_join(summary_rrm_annee_encours_ann,summary_alerte_rrm_ann%>%select(annee_incident,nb_alerte_sans_rrm),by=c("annee_incident"))

```

```{r }

summary_rrm_annee_encours_ann %>%
  dplyr::select(annee_incident, reponse_annuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Reponse du annee en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (BNA)

```{r }

summary_alerte_rrm_ann %>%
  dplyr::select(annee_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (BNA)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_ann <- df_ann %>%
  mutate(
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (BNA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_ann<-df_rrm%>%
    filter(uuid %in% rrm_bna_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (BNA)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_ann<-df_rrm%>%
    filter(uuid %in% rrm_bna_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Education

#### Alertes validées par type (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_ann<-df_alerte_education%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_ann<-df_alerte_education%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_ann <-df_rrm_education%>%
  filter(date_fin_reponse>=date_periode_prec_year&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_ann <-df_rrm_for_analysis_ann%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Education)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_education) > 0) {
df_rrm_education$me=NA

rrm_reshaped_ann <- process_response_data(
  df_rrm_education,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Education",
  nfi_response = "reponse_Education",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_education<-df_rrm_education%>%select(-me)

rrm_reshaped_ann<-rrm_reshaped_ann%>%select(-me)
} else {
  rrm_reshaped_ann <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)

}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_ann <- df_alerte_education %>% left_join(rrm_reshaped_ann, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

summary_alerte_rrm_ann <- df_ann %>%
  mutate(
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_annee_encours_ann<-df_ann%>%
  mutate(
         annee_incident = year(date_incident),
         rrm_annee_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref,1,0))%>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_annuelle_encours=sum(rrm_annee_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_annee_encours_ann <-left_join(summary_rrm_annee_encours_ann,summary_alerte_rrm_ann%>%select(annee_incident,nb_alerte_sans_rrm),by=c("annee_incident"))

```

```{r }

summary_rrm_annee_encours_ann %>%
  dplyr::select(annee_incident, reponse_annuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Reponse du annee en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Education)

```{r }

summary_alerte_rrm_ann %>%
  dplyr::select(annee_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Education)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_ann <- df_ann %>%
  mutate(
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Education)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_ann<-df_rrm%>%
    filter(uuid %in% rrm_education_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Education)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_ann<-df_rrm%>%
    filter(uuid %in% rrm_education_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Santé

#### Alertes validées par type (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_ann<-df_alerte_sante%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_ann<-df_alerte_sante%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_ann <-df_rrm_sante%>%
  filter(date_fin_reponse>=date_periode_prec_year&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_ann <-df_rrm_for_analysis_ann%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Santé)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_sante) > 0) {
df_rrm_sante$me=NA

rrm_reshaped_ann <- process_response_data(
  df_rrm_sante,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Santé",
  nfi_response = "reponse_Santé",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_sante<-df_rrm_sante%>%select(-me)

rrm_reshaped_ann<-rrm_reshaped_ann%>%select(-me)
} else {
  rrm_reshaped_ann <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
)
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_ann <- df_alerte_sante %>% left_join(rrm_reshaped_ann, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_ann <- df_ann %>%
  mutate(
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_annee_encours_ann<-df_ann%>%
  mutate(
         annee_incident = year(date_incident),
         rrm_annee_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref,1,0))%>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_annuelle_encours=sum(rrm_annee_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_annee_encours_ann <-left_join(summary_rrm_annee_encours_ann,summary_alerte_rrm_ann%>%select(annee_incident,nb_alerte_sans_rrm),by=c("annee_incident"))

```

```{r }

summary_rrm_annee_encours_ann %>%
  dplyr::select(annee_incident, reponse_annuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Reponse du annee en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Santé)

```{r }

summary_alerte_rrm_ann %>%
  dplyr::select(annee_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Santé)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_ann <- df_ann %>%
  mutate(
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Santé)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_ann<-df_rrm%>%
    filter(uuid %in% rrm_sante_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Santé)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_ann<-df_rrm%>%
    filter(uuid %in% rrm_sante_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### Protection

#### Alertes validées par type (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_ann<-df_alerte_protection%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_ann<-df_alerte_protection%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_ann <-df_rrm_protection%>%
  filter(date_fin_reponse>=date_periode_prec_year&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_ann <-df_rrm_for_analysis_ann%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (Protection)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_protection) > 0) {
df_rrm_protection$me=NA

rrm_reshaped_ann <- process_response_data(
  df_rrm_protection,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_Protection",
  nfi_response = "reponse_Protection",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_protection<-df_rrm_protection%>%select(-me)

rrm_reshaped_ann<-rrm_reshaped_ann%>%select(-me)
} else {
  rrm_reshaped_ann <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
) 
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_ann <- df_alerte_protection %>% left_join(rrm_reshaped_ann, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_ann <- df_ann %>%
  mutate(
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_annee_encours_ann<-df_ann%>%
  mutate(
         annee_incident = year(date_incident),
         rrm_annee_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref,1,0))%>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_annuelle_encours=sum(rrm_annee_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_annee_encours_ann <-left_join(summary_rrm_annee_encours_ann,summary_alerte_rrm_ann%>%select(annee_incident,nb_alerte_sans_rrm),by=c("annee_incident"))

```

```{r }

summary_rrm_annee_encours_ann %>%
  dplyr::select(annee_incident, reponse_annuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Reponse du annee en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (Protection)

```{r }

summary_alerte_rrm_ann %>%
  dplyr::select(annee_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (Protection)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_ann <- df_ann %>%
  mutate(
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (Protection)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_ann<-df_rrm%>%
    filter(uuid %in% rrm_protection_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (Protection)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_ann<-df_rrm%>%
    filter(uuid %in% rrm_protection_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

### MHM

#### Alertes validées par type (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_type_ann<-df_alerte_mhm%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,type_crise)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_type_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par type",
               col.names = colnames(summary_alert_by_type_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Alertes validées par region (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alert_by_region_ann<-df_alerte_mhm%>%
  mutate(
         annee_alerte=year(date_incident))%>%
  group_by(annee_alerte,region_arrivee)%>%
  summarise(
    nb_alerts=sum(statut_alerte=="Validée",na.rm = T),
    nb_menages=sum((statut_alerte=="Validée")*menages_estimes,na.rm = T),
    nb_personnes=sum((statut_alerte=="Validée")*personnes_estimees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_alert_by_region_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes par région",
               col.names = colnames(summary_alert_by_region_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")
```

#### Reponses par modalite (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }

df_rrm_for_analysis_ann <-df_rrm_mhm%>%
  filter(date_fin_reponse>=date_periode_prec_year&date_fin_reponse<=date_periode_act)


summary_reponse_by_modalite_ann <-df_rrm_for_analysis_ann%>%
  group_by(modalites_reponse)%>%
  summarise(
    nb_reponses=n(),
    nb_menages=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )
```

```{r }
summary_reponse_by_modalite_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des réponses par modalité",
               col.names = colnames(summary_reponse_by_modalite_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 15. Les alerts qui nécessitent une réponse RRM, et les réponses RRM (MHM)

```{r , echo=FALSE, message=FALSE, warning=FALSE }
if (nrow(df_rrm_mhm) > 0) {
df_rrm_mhm$me=NA

rrm_reshaped_ann <- process_response_data(
  df_rrm_mhm,
  uuid = "uuid",
  response_actor = "acteur_reponse",
  food_response = "reponse_vivres",
  wash_response = "reponse_MHM",
  nfi_response = "reponse_MHM",
  shelter_response = "reponse_abris",
  health_response = "reponse_sante",
  protection_response = "reponseprotection",
  mhm_response = "reponse_MHM",
  enriched_flour_response = "reponse_nutrition",
  education_response = "reponse_education",
  livelihood_response = "me",
  hh_number = "menages_assistes",
  ind_number = "personnes_assistees",
  response_start_date = "date_debut_reponse",
  response_end_date = "date_fin_reponse",
  response_donor = "bailleur_reponse",
  admin1 = "region_reponse",
  admin2 = "cercle_reponse"
)

df_rrm_mhm<-df_rrm_mhm%>%select(-me)

rrm_reshaped_ann<-rrm_reshaped_ann%>%select(-me)
} else {
  rrm_reshaped_ann <- data.frame(
  uuid                 = character(),
  response_number      = integer(),
  acteur_reponse       = character(),
  reponse_vivres       = integer(),
  reponse_EHA          = integer(),
  reponse_BNA          = integer(),
  reponse_abris        = integer(),
  reponse_sante        = integer(),
  reponseprotection    = integer(),
  reponse_MHM          = integer(),
  reponse_nutrition    = integer(),
  reponse_education    = integer(),
  menages_assistes     = numeric(),
  personnes_assistees  = numeric(),
  date_debut_reponse   = as.Date(character()),
  date_fin_reponse     = as.Date(character()),
  bailleur_reponse     = character(),
  region_reponse       = character(),
  cercle_reponse       = character(),
  stringsAsFactors = FALSE
) 
}
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }

 df_ann <- df_alerte_mhm %>% left_join(rrm_reshaped_ann, by=join_by(uuid == uuid))

```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_alerte_rrm_ann <- df_ann %>%
  mutate(
         annee_incident = year(date_incident)) %>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    all_validated_alerts = sum(statut_alerte == "Validée", na.rm = TRUE),
    nb_alerte_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number)), na.rm = TRUE),
    nb_alerte_avec_un_rrm=sum((statut_alerte == "Validée")*(response_number==1), na.rm = TRUE),
    nb_alerte_avec_deux_rrm=sum((statut_alerte == "Validée")*(response_number==2), na.rm = TRUE) , 
    nb_alerte_avec_trois_rrm=sum((statut_alerte == "Validée")*(response_number==3), na.rm = TRUE) , 
    nb_alerte_avec_plustrois_rrm=sum((statut_alerte == "Validée")*(response_number>3), na.rm = TRUE) , 
    alert_with_atleast_one_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number)), na.rm = TRUE) , 
    differential=all_validated_alerts-alert_with_atleast_one_rrm,
    menage_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*menages_assistes, na.rm = TRUE),
    personne_rrm=sum((statut_alerte == "Validée")*(!is.na(response_number))*personnes_assistees, na.rm = TRUE),
    menage_estime=sum((statut_alerte == "Validée")*menages_estimes, na.rm = TRUE),
    personne_estimee=sum((statut_alerte == "Validée")*personnes_estimees, na.rm = TRUE),
    nb_menage_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*menages_estimes, na.rm = TRUE),
    nb_personne_sans_rrm= sum((statut_alerte == "Validée")*(is.na(response_number))*personnes_estimees, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!is.na(annee_incident),annee_incident>2022) %>% 
  mutate(cumul_nb_alerte_sans_rrm = cumsum(nb_alerte_sans_rrm),
         cumul_nb_menage_rrm = cumsum(menage_rrm),
         cumul_nb_personne_rrm = cumsum(personne_rrm),
         cumul_nb_menage_estime = cumsum(menage_estime),
         cumul_nb_personne_estimee = cumsum(personne_estimee),
         cumul_nb_menage_sans_rrm = cumsum(nb_menage_sans_rrm),
         cumul_nb_personne_sans_rrm = cumsum(nb_personne_sans_rrm)) 
```

```{r , echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_annee_encours_ann<-df_ann%>%
  mutate(
         annee_incident = year(date_incident),
         rrm_annee_encours=ifelse(!is.na(response_number)& 
                                        year(date_fin_reponse)==year_ref,1,0))%>%
  group_by(annee_incident) %>%
  arrange(annee_incident) %>%
  summarise(
    reponse_annuelle_encours=sum(rrm_annee_encours,na.rm = TRUE)
  )%>%
  filter(!is.na(annee_incident),annee_incident>2022)

summary_rrm_annee_encours_ann <-left_join(summary_rrm_annee_encours_ann,summary_alerte_rrm_ann%>%select(annee_incident,nb_alerte_sans_rrm),by=c("annee_incident"))

```

```{r }

summary_rrm_annee_encours_ann %>%
  dplyr::select(annee_incident, reponse_annuelle_encours,
                nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Reponse du annee en cours",
                             "nombre d alertes sans réponse")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### 16. Les alertes qui nécessitent une réponse RRM, cumulées (MHM)

```{r }

summary_alerte_rrm_ann %>%
  dplyr::select(annee_incident, alert_with_atleast_one_rrm,
                nb_alerte_sans_rrm, cumul_nb_alerte_sans_rrm) %>%
  knitr::kable(format = "html",
               caption = "Résumé des alertes RRM",
               col.names = c("Année", "Alertes avec RRM",
                             "Alertes sans RRM", "Cumul alertes sans RRM")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Temps de reponse median (MHM)

```{r ,echo=FALSE, message=FALSE, warning=FALSE }
summary_response_time_ann <- df_ann %>%
  mutate(
         annee = year(date_incident),
         temps_alerte_validation=interval(date_incident,date_validation)%/%days(1),
         temps_validation_rrm=interval(date_validation,date_debut_reponse)%/%days(1),
         temps_rrm=interval(date_debut_reponse,date_fin_reponse)%/%days(1)
           ) %>%
  group_by(annee) %>%
  arrange(annee) %>%
  summarise(
    ecart_alerte_validation=round(median(temps_alerte_validation,na.rm=T)) ,
    ecart_validation_rrm=round(median(temps_validation_rrm,na.rm=T)),
    ecart_debut_fin_rrm=round(median(temps_rrm,na.rm=T)),
    ecart_alerte_rrm=ecart_alerte_validation+ecart_validation_rrm
  )  %>%
  filter(!is.na(annee),annee>2022)
```


```{r }
summary_response_time_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des délais de réponse",
               col.names = colnames(summary_response_time_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par bailleurs (MHM)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_bailleurs_ann<-df_rrm%>%
    filter(uuid %in% rrm_mhm_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,bailleur_reponse)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_bailleurs_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par bailleurs",
               col.names = colnames(summary_rrm_by_bailleurs_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```

#### Reponses par acteurs (MHM)

```{r, echo=FALSE, message=FALSE, warning=FALSE }
summary_rrm_by_acteur_ann<-df_rrm%>%
    filter(uuid %in% rrm_mhm_uuid) |>
  mutate(
         annee_alerte=year(date_fin_reponse))%>%
  group_by(annee_alerte,Acteur)%>%
  summarise(
    nb_alerts=n(),
    nb_menage=sum(menages_assistes,na.rm = T),
    nb_personnes=sum(personnes_assistees,na.rm = T)
  )%>%
  filter(annee_alerte>=year_ref)
```

```{r }
summary_rrm_by_acteur_ann %>%
  knitr::kable(format = "html",
               caption = "Résumé des reponses par acteurs",
               col.names = colnames(summary_rrm_by_acteur_ann)) %>%
  kableExtra::kable_styling("striped", full_width = FALSE, position = "center")

```
:::

:::